<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Reduce Runtime Permission Clutter (Headless Dialog Fragments!)</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.24" />
        


        
            <meta name="author" content="Tyler Roach">
        
        
            <meta name="description" content="A clean approach to managing runtime permissions">
        

        

  <meta name="twitter:card" content="summary"/>



<meta name="twitter:text:title" content="Reduce Runtime Permission Clutter (Headless Dialog Fragments!)"/>
<meta name="twitter:title" content="Reduce Runtime Permission Clutter (Headless Dialog Fragments!)"/>
<meta name="twitter:description" content="A clean approach to managing runtime permissions"/>
<meta name="twitter:site" content="@tylerjroach"/>

        <meta property="og:title" content="Reduce Runtime Permission Clutter (Headless Dialog Fragments!)" />
<meta property="og:description" content="A clean approach to managing runtime permissions" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://tylerjroach.com/blog/clean-runtime-permissions/" />



<meta property="article:published_time" content="2016-09-01T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-09-01T00:00:00&#43;00:00"/>











        
<meta itemprop="name" content="Reduce Runtime Permission Clutter (Headless Dialog Fragments!)">
<meta itemprop="description" content="A clean approach to managing runtime permissions">


<meta itemprop="dateModified" content="2016-09-01T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="795">



<meta itemprop="keywords" content="android,java," />

        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-101539783-1', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="/">Tyler Roach</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/blog">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        Categories
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://tylerjroach.com/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://tylerjroach.com/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/blog">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://tylerjroach.com/blog/clean-runtime-permissions/"><p>Reduce Runtime Permission Clutter (Headless Dialog Fragments!)</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&text=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29&via=tylerjroach" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&title=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&title=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&title=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Tyler%20Roach&body=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="http://tylerjroach.com/blog/clean-runtime-permissions/">Reduce Runtime Permission Clutter (Headless Dialog Fragments!)</a></h1>
            
        
        
            <p>A clean approach to managing runtime permissions</p>
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2016-09-01'>
            September 1, 2016</time>
        <span class="author">Tyler Roach</span>
        
            <p>4 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&text=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29&via=tylerjroach" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&title=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&title=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f&title=Reduce%20Runtime%20Permission%20Clutter%20%28Headless%20Dialog%20Fragments%21%29" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Tyler%20Roach&body=http%3a%2f%2ftylerjroach.com%2fblog%2fclean-runtime-permissions%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    

    <div id="content">
        <p>I know I’m late to the party implementing Android runtime permissions in the
<a href="https://play.google.com/store/apps/details?id=com.sparc.stream">Stream</a> app. We
had our reasons for this, but now that Nougat has been released, its time we
upgrade our targetSdkVersion to 24.</p>

<p>I’m not a huge fan of the design for runtime permissions. It can quickly clutter
your activity/fragment code as you have to handle multiple grant scenarios with
proper messaging to the user. In order to combat this, I decided to contain
nearly all aspects of permission management inside headless dialog fragments.</p>

<p>To show how this works, I’ve created an example app that demonstrates how to
request all necessary permissions to record videos (camera, mic, and storage).
The full source code can be found here for reference:
<a href="https://github.com/tylerjroach/RuntimePermissionsExample">https://github.com/tylerjroach/RuntimePermissionsExample</a>.
Lets go ahead and look at the entire CameraPermissionsDialogFragment source.</p>

<pre><code>public class CameraPermissionsDialogFragment extends DialogFragment{
  private final int PERMISSION_REQUEST_CODE = 11;

  private Context context;
  private CameraPermissionsGrantedCallback listener;

  private boolean shouldResolve;
  private boolean shouldRetry;
  private boolean externalGrantNeeded;

  public static CameraPermissionsDialogFragment newInstance() {
    return new CameraPermissionsDialogFragment();
  }

  public CameraPermissionsDialogFragment() {}

  @Override public void onAttach(Context context) {
    super.onAttach(context);
    this.context = context;
    if (context instanceof CameraPermissionsGrantedCallback) {
      listener = (CameraPermissionsGrantedCallback) context;
    }
  }

  @Override public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setStyle(STYLE_NO_TITLE, R.style.PermissionsDialogFragmentStyle);
    setCancelable(false);
    requestNecessaryPermissions();
  }

  @Override public void onResume() {
    super.onResume();
    if (shouldResolve) {
      if (externalGrantNeeded) {
        showAppSettingsDialog();
      } else if(shouldRetry) {
        showRetryDialog();
      } else {
        //permissions have been accepted
        if (listener != null) {
          listener.navigateToCaptureFragment();
          dismiss();
        }
      }
    }
  }

  @Override public void onDetach() {
    super.onDetach();
    context = null;
    listener = null;
  }

  @Override public void onRequestPermissionsResult(int requestCode,
      String permissions[], int[] grantResults) {
    shouldResolve = true;
    shouldRetry = false;

    for (int i=0; i&lt;permissions.length; i++) {
      String permission = permissions[i];
      int grantResult = grantResults[i];

      if (!shouldShowRequestPermissionRationale(permission) &amp;&amp; grantResult != PackageManager.PERMISSION_GRANTED) {
        externalGrantNeeded = true;
        return;
      } else if (grantResult != PackageManager.PERMISSION_GRANTED) {
        shouldRetry = true;
        return;
      }
    }
  }

  private void requestNecessaryPermissions() {
    requestPermissions(new String[] {
        Manifest.permission.CAMERA,
        Manifest.permission.RECORD_AUDIO,
        Manifest.permission.WRITE_EXTERNAL_STORAGE}, PERMISSION_REQUEST_CODE);
  }

  private void showAppSettingsDialog() {
    new AlertDialog.Builder(context)
        .setTitle(&quot;Permissions Required&quot;)
        .setMessage(&quot;In order to record videos, access to the camera, microphone, and storage is needed. Please enable these permissions from the app settings.&quot;)
        .setPositiveButton(&quot;App Settings&quot;, new DialogInterface.OnClickListener() {
          @Override public void onClick(DialogInterface dialogInterface, int i) {
            Intent intent = new Intent();
            intent.setAction(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
            Uri uri = Uri.fromParts(&quot;package&quot;, context.getApplicationContext().getPackageName(), null);
            intent.setData(uri);
            context.startActivity(intent);
            dismiss();
          }
        })
        .setNegativeButton(&quot;Cancel&quot;, new DialogInterface.OnClickListener() {
          @Override public void onClick(DialogInterface dialogInterface, int i) {
            dismiss();
          }
        }).create().show();
  }

  private void showRetryDialog() {
    new AlertDialog.Builder(context)
        .setTitle(&quot;Permissions Declined&quot;)
        .setMessage(&quot;In order to record videos, the app needs access to the camera, microphone, and storage.&quot;)
        .setPositiveButton(&quot;Retry&quot;, new DialogInterface.OnClickListener() {
          @Override public void onClick(DialogInterface dialogInterface, int i) {
            requestNecessaryPermissions();
          }
        })
        .setNegativeButton(&quot;Cancel&quot;, new DialogInterface.OnClickListener() {
          @Override public void onClick(DialogInterface dialogInterface, int i) {
            dismiss();
          }
        }).create().show();
  }

  public interface CameraPermissionsGrantedCallback {
    void navigateToCaptureFragment();
  }
}
</code></pre>

<p>In onCreate(), we call requestNecessaryPermissions(). This prompts the user to
deny/allow each requested permission, and the results are passed to
onRequestPermissionResult(). In this example, we are checking for 3 possible
scenarios:</p>

<ol>
<li>All permissions accepted</li>
<li>One or more permissions denied</li>
<li>One or more permissions denied and “Don’t ask again” checked</li>
</ol>

<p>Regardless of the outcome, you will want to be careful in what you update in
onRequestPermissionResult(). The results are passed down to this method while
the app is in a paused state. As a result, certain actions can cause a crash
(Ex. IllegalStateException from a FragmentTransaction commit). To work around
this, I set boolean flags on the action to take, and built onResume() to handle
the action once the app is back into the foreground. This will guarantee that
fragment transactions will be safe to run, and the ui will be safe to update.</p>

<p>Now, lets go back to our activity that is requesting the runtime permissions.
You can see that the activity is only responsible for checking if any
permissions are needed before opening the camera. You can see how the activity
code could quickly become cluttered if we didn’t separate the permission
requests into our DialogFragment.</p>

<pre><code>@Override protected void onResume() {
  super.onResume();
  if (isPermissionGranted()) {
    status.setText(&quot;All permissions granted. Ready to open Camera&quot;);
  } else {
    status.setText(&quot;Permissions Needed&quot;);
  }
}

@Override public void navigateToCaptureFragment() {
  if (isPermissionGranted()) {
    Toast.makeText(this, &quot;Opening Camera!&quot;, Toast.LENGTH_LONG).show();
  } else {
    CameraPermissionsDialogFragment.newInstance().show(getSupportFragmentManager(), CameraPermissionsDialogFragment.class.getName());
  }
}

private boolean isPermissionGranted() {
  return ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED &amp;&amp;
      ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) == PackageManager.PERMISSION_GRANTED &amp;&amp;
      ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED;
}
</code></pre>

<p>Side notes:</p>

<ul>
<li>I used a DialogFragment, however, a standard Headless Fragment could have worked
as well. I chose to use a dialog fragment because setCancelable(false) can
easily prevent all outside touches, as well as the simple creation/destruction
with show() and dismiss().</li>
<li>By default, a DialogFragment dims the screen background content. To remove this,
simply use this style on the dialog.</li>
</ul>

<pre><code>&lt;style name=&quot;PermissionsDialogFragmentStyle&quot; parent=&quot;Base.Theme.AppCompat.Dialog&quot;&gt;
   &lt;item name=&quot;android:backgroundDimEnabled&quot;&gt;false&lt;/item&gt;
&lt;/style&gt;
</code></pre>

<p>I look forward to reading any comments or questions you may have!</p>

    </div>

    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesandroid'>android</a></li>
    
        <li><a href='/categoriesjava'>java</a></li>
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    

    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'tylerjroach';
    var disqus_identifier = 'http:\/\/tylerjroach.com\/blog\/clean-runtime-permissions\/';
    var disqus_title = 'Reduce Runtime Permission Clutter (Headless Dialog Fragments!)';
    var disqus_url = 'http:\/\/tylerjroach.com\/blog\/clean-runtime-permissions\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="/img/me.jpg" class="intro-circle" width="" alt="Tyler Roach Profile Photo" />
                
            
            
                <header>
                    <h2>Tyler Roach</h2>
                    <p>Lead Android Dev @ Stream.Live | Owner Appterial, LLC</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/tylerjroach" target="_blank" title="GitHub" class="fa fa-github"></a></li>



































<li><a href="//linkedin.com/in/tylerjroach" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>















<li><a href="//twitter.com/tylerjroach" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:tyler@appterial.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://tylerjroach.com/blog/clean-runtime-permissions/">Reduce Runtime Permission Clutter (Headless Dialog Fragments!)</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-09-01'>
                                    September 1, 2016</time>
                            </header>
                        </article>
                    </li>
                

                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/android/">android</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/java/">java</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/tylerjroach" target="_blank" title="GitHub" class="fa fa-github"></a></li>



































<li><a href="//linkedin.com/in/tylerjroach" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>















<li><a href="//twitter.com/tylerjroach" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:tyler@appterial.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Tyler Roach. Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a>. Ported by <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

